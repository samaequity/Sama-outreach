<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SAMA Outreach Platform</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #141925;
      --bg-tertiary: #1e2433;
      --accent-primary: #00d9ff;
      --accent-secondary: #7c3aed;
      --text-primary: #e4e8f1;
      --text-secondary: #9ca3af;
      --border-color: #2d3548;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
    }

    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 2.5rem;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: -0.5px;
    }

    .nav-menu {
      list-style: none;
      flex: 1;
    }

    .nav-item {
      margin-bottom: 0.5rem;
    }

    .nav-link {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
      font-weight: 500;
    }

    .nav-link:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-link.active {
      background: linear-gradient(135deg, rgba(0, 217, 255, 0.1), rgba(124, 58, 237, 0.1));
      color: var(--accent-primary);
      border-left: 3px solid var(--accent-primary);
    }

    .nav-icon {
      margin-right: 0.75rem;
      font-size: 1.2rem;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 2rem 3rem;
    }

    .page-header {
      margin-bottom: 2rem;
      animation: fadeInDown 0.6s ease;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--text-primary), var(--text-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .page-subtitle {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    /* Cards */
    .card {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
      animation: fadeInUp 0.6s ease;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0, 217, 255, 0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-primary);
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }

    /* Forms */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.9rem;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 0.75rem 1rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
    }

    .form-textarea {
      resize: vertical;
      min-height: 120px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      animation: fadeInUp 0.6s ease;
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .stat-change {
      margin-top: 0.5rem;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .stat-change.positive {
      color: var(--success);
    }

    .stat-change.negative {
      color: var(--danger);
    }

    /* Table */
    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    thead {
      background: var(--bg-tertiary);
    }

    th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-secondary);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border-color);
    }

    td {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    tr:hover {
      background: var(--bg-tertiary);
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.2);
      color: var(--danger);
    }

    .badge-info {
      background: rgba(0, 217, 255, 0.2);
      color: var(--accent-primary);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      border: 1px solid var(--border-color);
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1.5rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
    }

    /* Progress Bar */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    /* Campaign Builder */
    .sequence-step {
      background: var(--bg-tertiary);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border-left: 3px solid var(--accent-primary);
      position: relative;
    }

    .sequence-step::before {
      content: '';
      position: absolute;
      left: -11px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      background: var(--accent-primary);
      border-radius: 50%;
      border: 3px solid var(--bg-secondary);
    }

    .step-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .step-number {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      color: var(--accent-primary);
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }

    /* Action Buttons */
    .action-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .action-btn:hover {
      background: var(--bg-primary);
      color: var(--accent-primary);
    }

    .page-content {
      display: none;
    }

    .page-content.active {
      display: block;
    }

    /* Merge field badge */
    .merge-field {
      display: inline-block;
      background: rgba(124, 58, 237, 0.2);
      color: var(--accent-secondary);
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .help-text {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      
      .main-content {
        margin-left: 0;
        padding: 1.5rem;
      }

      .grid-2 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">SAMA//OUTREACH</div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a class="nav-link active" data-page="dashboard">
            <span class="nav-icon">üìä</span>
            Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-page="contacts">
            <span class="nav-icon">üë•</span>
            Contacts
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-page="templates">
            <span class="nav-icon">üìù</span>
            Templates
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-page="campaigns">
            <span class="nav-icon">üöÄ</span>
            Campaigns
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-page="analytics">
            <span class="nav-icon">üìà</span>
            Analytics
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-page="settings">
            <span class="nav-icon">‚öôÔ∏è</span>
            Settings
          </a>
        </li>
      </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard Page -->
      <div id="dashboard" class="page-content active">
        <div class="page-header">
          <h1 class="page-title">Dashboard</h1>
          <p class="page-subtitle">Overview of your outreach performance</p>
        </div>

        <div style="margin-bottom: 1.5rem;">
          <button class="btn btn-primary" onclick="syncInbox()" id="syncInboxBtn">
            üîÑ Sync Inbox for Replies
          </button>
          <span id="lastSyncTime" style="margin-left: 1rem; color: var(--text-secondary); font-size: 0.9rem;"></span>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalContacts">0</div>
            <div class="stat-label">Total Contacts</div>
            <div class="stat-change positive">
              <span>‚Üë</span> 0% from last week
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="activeCampaigns">0</div>
            <div class="stat-label">Active Campaigns</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="emailsSent">0</div>
            <div class="stat-label">Emails Sent</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="responseRate">0%</div>
            <div class="stat-label">Response Rate</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Campaigns</h3>
          </div>
          <div id="recentCampaignsTable"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Replies</h3>
          </div>
          <div id="recentRepliesContainer"></div>
        </div>
      </div>

      <!-- Contacts Page -->
      <div id="contacts" class="page-content">
        <div class="page-header">
          <h1 class="page-title">Contacts</h1>
          <p class="page-subtitle">Manage your contact database</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Contact List</h3>
            <div style="display: flex; gap: 1rem;">
              <button class="btn btn-secondary btn-sm" onclick="importContacts()">
                üì• Import Excel/CSV
              </button>
              <button class="btn btn-primary btn-sm" onclick="openAddContactModal()">
                ‚ûï Add Contact
              </button>
              <button class="btn btn-danger btn-sm" onclick="deleteAllContacts()">
                üóëÔ∏è Delete All
              </button>
            </div>
          </div>
          
          <!-- Search and Filter Bar -->
          <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center;">
            <div style="flex: 1;">
              <input 
                type="text" 
                id="contactSearch" 
                class="form-input" 
                placeholder="üîç Search by name, email, company, or location..." 
                onkeyup="filterContacts()"
                style="margin: 0;"
              >
            </div>
            <div style="width: 200px;">
              <select class="form-select" id="statusFilter" onchange="filterContacts()" style="margin: 0;">
                <option value="">All Statuses</option>
                <option value="prospect">Prospect</option>
                <option value="reached_out">Reached Out</option>
                <option value="responded">Responded</option>
                <option value="follow_up">Follow-up</option>
                <option value="engaged">Engaged</option>
                <option value="unresponsive">Unresponsive</option>
              </select>
            </div>
            <div style="width: 150px;">
              <select class="form-select" id="segmentFilter" onchange="filterContacts()" style="margin: 0;">
                <option value="">All Segments</option>
                <option value="prospect">Prospect</option>
                <option value="lead">Lead</option>
                <option value="customer">Customer</option>
                <option value="partner">Partner</option>
              </select>
            </div>
          </div>
          
          <div id="contactsTableContainer"></div>
        </div>
      </div>

      <!-- Templates Page -->
      <div id="templates" class="page-content">
        <div class="page-header">
          <h1 class="page-title">Email Templates</h1>
          <p class="page-subtitle">Create and manage personalized email templates</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Your Templates</h3>
            <button class="btn btn-primary btn-sm" onclick="openTemplateModal()">
              ‚ûï New Template
            </button>
          </div>
          <div id="templatesContainer"></div>
        </div>
      </div>

      <!-- Campaigns Page -->
      <div id="campaigns" class="page-content">
        <div class="page-header">
          <h1 class="page-title">Campaigns</h1>
          <p class="page-subtitle">Build and manage automated email sequences</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Your Campaigns</h3>
            <button class="btn btn-primary btn-sm" onclick="openCampaignModal()">
              ‚ûï New Campaign
            </button>
          </div>
          <div id="campaignsContainer"></div>
        </div>
      </div>

      <!-- Analytics Page -->
      <div id="analytics" class="page-content">
        <div class="page-header">
          <h1 class="page-title">Analytics</h1>
          <p class="page-subtitle">Track your outreach performance</p>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="openRate">0%</div>
            <div class="stat-label">Open Rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="clickRate">0%</div>
            <div class="stat-label">Click Rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="replyRate">0%</div>
            <div class="stat-label">Reply Rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="bounceRate">0%</div>
            <div class="stat-label">Bounce Rate</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Campaign Performance</h3>
          </div>
          <div id="analyticsTable"></div>
        </div>
      </div>

      <!-- Settings Page -->
      <div id="settings" class="page-content">
        <div class="page-header">
          <h1 class="page-title">Settings</h1>
          <p class="page-subtitle">Configure your outreach platform</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Email Integration</h3>
          </div>
          <div style="padding: 1rem 0;">
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
              <div>
                <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">Microsoft 365 / Outlook</h4>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0;">Connect your Microsoft account to send real emails</p>
                <p id="msftStatus" style="margin-top: 0.5rem; font-size: 0.85rem;"></p>
              </div>
              <button class="btn btn-primary" onclick="connectMicrosoft()" id="msftConnectBtn">
                Connect Account
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Contact Status Automation</h3>
          </div>
          <div style="padding: 1rem 0;">
            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
              <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Status Flow Rules</h4>
              <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.8;">
                <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                  <span class="badge badge-info" style="margin-right: 0.5rem;">Prospect</span> ‚Üí Initial status for new contacts
                </div>
                <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                  <span class="badge badge-warning" style="margin-right: 0.5rem;">Reached Out</span> ‚Üí Auto-set when first email is sent
                </div>
                <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                  <span class="badge badge-success" style="margin-right: 0.5rem;">Responded</span> ‚Üí Auto-set when contact replies
                </div>
                <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                  <span class="badge badge-info" style="margin-right: 0.5rem;">Follow-up</span> ‚Üí Auto-set when follow-up email is sent
                </div>
                <div style="padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                  <span class="badge badge-success" style="margin-right: 0.5rem;">Engaged</span> ‚Üí Multiple back-and-forth responses
                </div>
                <div style="padding: 0.5rem 0;">
                  <span class="badge badge-danger" style="margin-right: 0.5rem;">Unresponsive</span> ‚Üí No response after 3+ emails
                </div>
              </div>
            </div>
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer;">
              <input type="checkbox" id="autoStatusToggle" checked style="width: 20px; height: 20px; cursor: pointer;">
              <span style="color: var(--text-primary); font-weight: 500;">Enable automatic status updates</span>
            </label>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Data Management</h3>
          </div>
          <div style="padding: 1rem 0;">
            <button class="btn btn-secondary" onclick="exportData()">
              üì§ Export All Data
            </button>
            <button class="btn btn-danger" onclick="clearAllData()" style="margin-left: 1rem; background: var(--danger);">
              üóëÔ∏è Clear All Data
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Contact Modal -->
  <div id="addContactModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add New Contact</h2>
        <button class="modal-close" onclick="closeModal('addContactModal')">√ó</button>
      </div>
      <div class="modal-body">
        <form id="addContactForm">
          <div class="form-group">
            <label class="form-label">Name *</label>
            <input type="text" class="form-input" id="contactName" required>
          </div>
          <div class="form-group">
            <label class="form-label">Email *</label>
            <input type="email" class="form-input" id="contactEmail" required>
          </div>
          <div class="form-group">
            <label class="form-label">Company</label>
            <input type="text" class="form-input" id="contactCompany">
          </div>
          <div class="form-group">
            <label class="form-label">Title</label>
            <input type="text" class="form-input" id="contactTitle">
          </div>
          <div class="form-group">
            <label class="form-label">Location</label>
            <input type="text" class="form-input" id="contactLocation" placeholder="e.g., New York, NY or London, UK">
          </div>
          <div class="form-group">
            <label class="form-label">Segment</label>
            <select class="form-select" id="contactSegment">
              <option value="prospect">Prospect</option>
              <option value="lead">Lead</option>
              <option value="customer">Customer</option>
              <option value="partner">Partner</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Status</label>
            <select class="form-select" id="contactStatus">
              <option value="prospect">Prospect</option>
              <option value="reached_out">Reached Out</option>
              <option value="responded">Responded</option>
              <option value="follow_up">Follow-up</option>
              <option value="engaged">Engaged</option>
              <option value="unresponsive">Unresponsive</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addContactModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveContact()">Save Contact</button>
      </div>
    </div>
  </div>

  <!-- Template Modal -->
  <div id="templateModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="templateModalTitle">Create Template</h2>
        <button class="modal-close" onclick="closeModal('templateModal')">√ó</button>
      </div>
      <div class="modal-body">
        <form id="templateForm">
          <div class="form-group">
            <label class="form-label">Template Name *</label>
            <input type="text" class="form-input" id="templateName" required>
          </div>
          <div class="form-group">
            <label class="form-label">Subject Line *</label>
            <input type="text" class="form-input" id="templateSubject" required>
            <div class="help-text">
              Use merge fields: <span class="merge-field">{{name}}</span> 
              <span class="merge-field">{{company}}</span> 
              <span class="merge-field">{{title}}</span>
              <span class="merge-field">{{location}}</span>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Email Body *</label>
            <textarea class="form-textarea" id="templateBody" required placeholder="Hi {{name}},

I came across {{company}} and was impressed...

Best,
Hassan"></textarea>
            <div class="help-text">
              Available merge fields: {{name}}, {{company}}, {{title}}, {{location}}, {{email}}<br>
              <strong>Tip:</strong> Press Enter for line breaks. They will be preserved in the email.
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('templateModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTemplate()">Save Template</button>
      </div>
    </div>
  </div>

  <!-- Campaign Modal -->
  <div id="campaignModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Create Campaign</h2>
        <button class="modal-close" onclick="closeModal('campaignModal')">√ó</button>
      </div>
      <div class="modal-body">
        <form id="campaignForm">
          <div class="form-group">
            <label class="form-label">Campaign Name *</label>
            <input type="text" class="form-input" id="campaignName" required>
          </div>
          <div class="form-group">
            <label class="form-label">Select Template *</label>
            <select class="form-select" id="campaignTemplate" required>
              <option value="">Choose a template...</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Target Segment</label>
            <select class="form-select" id="campaignSegment">
              <option value="all">All Contacts</option>
              <option value="prospect">Prospects</option>
              <option value="lead">Leads</option>
              <option value="customer">Customers</option>
              <option value="partner">Partners</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Follow-up Sequence</label>
            <div id="sequenceSteps">
              <div class="sequence-step">
                <div class="step-header">
                  <span class="step-number">Step 1: Initial Email</span>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Uses selected template above</p>
              </div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="addFollowUpStep()">
              ‚ûï Add Follow-up
            </button>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('campaignModal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveCampaign()">Create Campaign</button>
      </div>
    </div>
  </div>

  <script>
    // Data Storage (using localStorage for persistence)
    const storage = {
      get: (key) => {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      },
      set: (key, value) => {
        localStorage.setItem(key, JSON.stringify(value));
      },
      init: () => {
        if (!storage.get('contacts')) storage.set('contacts', []);
        if (!storage.get('templates')) storage.set('templates', []);
        if (!storage.get('campaigns')) storage.set('campaigns', []);
        if (!storage.get('msftAuth')) storage.set('msftAuth', null);
        if (!storage.get('emailActivity')) storage.set('emailActivity', []);
      }
    };

    // Microsoft 365 Integration
    const msftConfig = {
      clientId: '', // User will need to provide this
      redirectUri: window.location.origin + window.location.pathname,
      scopes: ['Mail.Send', 'Mail.Read', 'User.Read']
    };

    async function connectMicrosoft() {
      const clientId = prompt('Enter your Microsoft App Client ID:\n\n(To get one, visit https://portal.azure.com ‚Üí App registrations ‚Üí New registration)\n\nLeave blank to skip for now.');
      
      if (!clientId) {
        alert('You can connect later from Settings. For now, the platform will simulate email sends.');
        return;
      }

      // Store client ID
      storage.set('msftClientId', clientId);
      msftConfig.clientId = clientId;
      
      // Use implicit flow for localhost
      const nonce = Math.random().toString(36).substring(7);
      sessionStorage.setItem('pendingMsftAuth', 'true');
      sessionStorage.setItem('authNonce', nonce);
      
      const authUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?` +
        `client_id=${clientId}` +
        `&response_type=token` +
        `&redirect_uri=${encodeURIComponent(msftConfig.redirectUri)}` +
        `&scope=${encodeURIComponent(msftConfig.scopes.join(' '))}` +
        `&nonce=${nonce}` +
        `&prompt=select_account`;
      
      window.location.href = authUrl;
    }

    function generateCodeVerifier() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return btoa(String.fromCharCode.apply(null, array))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
    }

    async function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode.apply(null, new Uint8Array(hash)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
    }

    async function handleMicrosoftCallback() {
      // Check for errors in query string
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get('error');
      const errorDesc = urlParams.get('error_description');
      
      if (error) {
        alert(`Microsoft authentication error: ${error}\n${errorDesc || ''}`);
        window.history.replaceState({}, document.title, window.location.pathname);
        sessionStorage.removeItem('pendingMsftAuth');
        return;
      }
      
      // Check for access token in URL fragment (implicit flow)
      const hash = window.location.hash.substring(1);
      const hashParams = new URLSearchParams(hash);
      const accessToken = hashParams.get('access_token');
      const expiresIn = hashParams.get('expires_in');
      
      if (accessToken && sessionStorage.getItem('pendingMsftAuth') === 'true') {
        // Show loading message
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-color); z-index: 10000; text-align: center;';
        loadingDiv.innerHTML = '<h3 style="color: var(--text-primary); margin-bottom: 1rem;">‚úÖ Connected Successfully!</h3><p style="color: var(--text-secondary);">Setting up your account...</p>';
        document.body.appendChild(loadingDiv);
        
        try {
          // Store the token
          storage.set('msftAuth', {
            accessToken: accessToken,
            expiresAt: Date.now() + (parseInt(expiresIn) * 1000)
          });
          
          setTimeout(() => {
            document.body.removeChild(loadingDiv);
            alert('‚úÖ Microsoft 365 connected successfully!\n\nYou can now send real emails from hassan@samaequity.com through your campaigns.');
            sessionStorage.removeItem('pendingMsftAuth');
            sessionStorage.removeItem('authNonce');
            
            // Clean URL and refresh
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Refresh settings page if on it
            if (document.getElementById('settings').classList.contains('active')) {
              updateSettingsPage();
            }
          }, 500);
        } catch (error) {
          if (document.body.contains(loadingDiv)) {
            document.body.removeChild(loadingDiv);
          }
          alert('Error saving authentication: ' + error.message);
          sessionStorage.removeItem('pendingMsftAuth');
          window.history.replaceState({}, document.title, window.location.pathname);
        }
      }
    }

    async function sendEmailViaMicrosoft(to, subject, body) {
      const auth = storage.get('msftAuth');
      
      if (!auth || Date.now() > auth.expiresAt) {
        throw new Error('Microsoft authentication expired. Please reconnect.');
      }

      // Convert plain text line breaks to HTML
      const htmlBody = body
        .replace(/\n/g, '<br>')
        .replace(/\r\n/g, '<br>')
        .replace(/\r/g, '<br>');

      const message = {
        message: {
          subject: subject,
          body: {
            contentType: 'HTML',
            content: htmlBody
          },
          toRecipients: [{ emailAddress: { address: to } }]
        }
      };

      const response = await fetch('https://graph.microsoft.com/v1.0/me/sendMail', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${auth.accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(message)
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error?.message || 'Failed to send email');
      }

      return true;
    }

    async function syncInbox() {
      const auth = storage.get('msftAuth');
      
      if (!auth || Date.now() > auth.expiresAt) {
        alert('Please connect Microsoft 365 in Settings first.');
        return;
      }

      const btn = document.getElementById('syncInboxBtn');
      btn.disabled = true;
      btn.textContent = 'üîÑ Syncing...';

      try {
        // Get emails from the last 30 days
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const filterDate = thirtyDaysAgo.toISOString();

        const response = await fetch(
          `https://graph.microsoft.com/v1.0/me/messages?$filter=receivedDateTime ge ${filterDate}&$top=100&$select=from,subject,receivedDateTime,isRead`,
          {
            headers: {
              'Authorization': `Bearer ${auth.accessToken}`
            }
          }
        );

        if (!response.ok) {
          throw new Error('Failed to fetch emails');
        }

        const data = await response.json();
        const contacts = storage.get('contacts');
        let newReplies = 0;

        // Check each email against our contacts
        data.value.forEach(email => {
          const senderEmail = email.from.emailAddress.address.toLowerCase();
          const contact = contacts.find(c => c.email.toLowerCase() === senderEmail);
          
          if (contact) {
            // Check if we've already logged this reply
            const activity = storage.get('emailActivity') || [];
            const alreadyLogged = activity.find(a => 
              a.contactEmail === contact.email && 
              a.type === 'email_received' &&
              Math.abs(new Date(a.timestamp) - new Date(email.receivedDateTime)) < 1000
            );

            if (!alreadyLogged) {
              logEmailActivity(contact.email, 'email_received', email.subject);
              newReplies++;
            }
          }
        });

        storage.set('lastSyncTime', new Date().toISOString());
        
        btn.disabled = false;
        btn.textContent = 'üîÑ Sync Inbox for Replies';
        
        if (newReplies > 0) {
          alert(`‚úÖ Found ${newReplies} new ${newReplies === 1 ? 'reply' : 'replies'}!\n\nContact statuses have been updated.`);
        } else {
          alert('‚úÖ Inbox synced! No new replies found.');
        }
        
        updateDashboard();
        updateLastSyncTime();
        
      } catch (error) {
        btn.disabled = false;
        btn.textContent = 'üîÑ Sync Inbox for Replies';
        alert('Error syncing inbox: ' + error.message);
      }
    }

    function updateLastSyncTime() {
      const lastSync = storage.get('lastSyncTime');
      const element = document.getElementById('lastSyncTime');
      
      if (lastSync) {
        const date = new Date(lastSync);
        const now = new Date();
        const diffMinutes = Math.floor((now - date) / 60000);
        
        let timeStr;
        if (diffMinutes < 1) {
          timeStr = 'Just now';
        } else if (diffMinutes < 60) {
          timeStr = `${diffMinutes} ${diffMinutes === 1 ? 'minute' : 'minutes'} ago`;
        } else {
          const diffHours = Math.floor(diffMinutes / 60);
          timeStr = `${diffHours} ${diffHours === 1 ? 'hour' : 'hours'} ago`;
        }
        
        element.textContent = `Last synced: ${timeStr}`;
      }
    }

    // Initialize storage
    storage.init();

    // Navigation
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const page = this.dataset.page;
        
        // Update active nav
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        
        // Show page
        document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
        document.getElementById(page).classList.add('active');
        
        // Load page data
        loadPageData(page);
      });
    });

    // Modal Functions
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function openAddContactModal() {
      document.getElementById('addContactForm').reset();
      document.getElementById('addContactModal').classList.add('active');
    }

    function openTemplateModal() {
      document.getElementById('templateForm').reset();
      document.getElementById('templateModalTitle').textContent = 'Create Template';
      document.getElementById('templateModal').classList.add('active');
    }

    function openCampaignModal() {
      document.getElementById('campaignForm').reset();
      loadTemplateOptions();
      document.getElementById('campaignModal').classList.add('active');
    }

    // Contact Functions
    function saveContact() {
      const name = document.getElementById('contactName').value;
      const email = document.getElementById('contactEmail').value;
      const company = document.getElementById('contactCompany').value;
      const title = document.getElementById('contactTitle').value;
      const location = document.getElementById('contactLocation').value;
      const segment = document.getElementById('contactSegment').value;
      const status = document.getElementById('contactStatus').value;

      const contacts = storage.get('contacts');
      contacts.push({
        id: Date.now(),
        name,
        email,
        company,
        title,
        location,
        segment,
        status,
        addedDate: new Date().toISOString(),
        emailsSent: 0,
        emailsReceived: 0
      });

      storage.set('contacts', contacts);
      closeModal('addContactModal');
      loadPageData('contacts');
      updateDashboard();
    }

    function importContacts() {
      // Create file input
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.xlsx,.xls,.csv';
      
      fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          if (file.name.endsWith('.csv')) {
            // Handle CSV
            const text = await file.text();
            parseCSV(text);
          } else {
            // Handle Excel with SheetJS
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
            
            parseExcelData(jsonData);
          }
        } catch (error) {
          alert('Error reading file: ' + error.message);
        }
      };
      
      fileInput.click();
    }

    function parseCSV(csvData) {
      const contacts = storage.get('contacts');
      const lines = csvData.split('\n');
      let imported = 0;
      
      lines.forEach((line, index) => {
        if (index === 0 || !line.trim()) return; // Skip header
        const [name, email, company, title, segment] = line.split(',').map(s => s.trim());
        if (email) {
          contacts.push({
            id: Date.now() + index,
            name: name || 'Unknown',
            email,
            company: company || '',
            title: title || '',
            segment: segment || 'prospect',
            status: 'active',
            addedDate: new Date().toISOString()
          });
          imported++;
        }
      });

      storage.set('contacts', contacts);
      loadPageData('contacts');
      updateDashboard();
      alert(`Successfully imported ${imported} contacts!`);
    }

    function parseExcelData(jsonData) {
      const contacts = storage.get('contacts');
      let imported = 0;
      
      // Try to auto-detect column names (case-insensitive)
      const getColumn = (row, possibleNames) => {
        for (let name of possibleNames) {
          const key = Object.keys(row).find(k => k.toLowerCase().includes(name.toLowerCase()));
          if (key) return row[key];
        }
        return '';
      };
      
      jsonData.forEach((row, index) => {
        const email = getColumn(row, ['email', 'e-mail', 'mail']);
        const name = getColumn(row, ['name', 'full name', 'contact name', 'first name']);
        const company = getColumn(row, ['company', 'organization', 'org', 'business']);
        const title = getColumn(row, ['title', 'position', 'job title', 'role']);
        const location = getColumn(row, ['location', 'city', 'country', 'region', 'address', 'state']);
        const segment = getColumn(row, ['segment', 'type', 'category', 'tag']);
        
        if (email && email.toString().includes('@')) {
          contacts.push({
            id: Date.now() + index,
            name: name ? name.toString() : 'Unknown',
            email: email.toString(),
            company: company ? company.toString() : '',
            title: title ? title.toString() : '',
            location: location ? location.toString() : '',
            segment: segment ? segment.toString().toLowerCase() : 'prospect',
            status: 'prospect',
            addedDate: new Date().toISOString(),
            emailsSent: 0,
            emailsReceived: 0
          });
          imported++;
        }
      });

      storage.set('contacts', contacts);
      loadPageData('contacts');
      updateDashboard();
      alert(`Successfully imported ${imported} contacts from Excel!`);
    }

    function deleteContact(id) {
      if (!confirm('Are you sure you want to delete this contact?')) return;
      
      const contacts = storage.get('contacts').filter(c => c.id !== id);
      storage.set('contacts', contacts);
      loadPageData('contacts');
      updateDashboard();
    }

    function deleteAllContacts() {
      if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL contacts!\n\nAre you absolutely sure?')) return;
      if (!confirm('This cannot be undone! Delete all contacts?')) return;
      
      storage.set('contacts', []);
      loadPageData('contacts');
      updateDashboard();
      alert('All contacts have been deleted.');
    }

    function filterContacts() {
      const searchTerm = document.getElementById('contactSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const segmentFilter = document.getElementById('segmentFilter').value;
      
      let contacts = storage.get('contacts');
      
      // Apply search filter
      if (searchTerm) {
        contacts = contacts.filter(c => 
          c.name.toLowerCase().includes(searchTerm) ||
          c.email.toLowerCase().includes(searchTerm) ||
          (c.company && c.company.toLowerCase().includes(searchTerm)) ||
          (c.location && c.location.toLowerCase().includes(searchTerm))
        );
      }
      
      // Apply status filter
      if (statusFilter) {
        contacts = contacts.filter(c => c.status === statusFilter);
      }
      
      // Apply segment filter
      if (segmentFilter) {
        contacts = contacts.filter(c => c.segment === segmentFilter);
      }
      
      renderContactsTable(contacts);
    }

    function updateContactStatus(contactId, newStatus) {
      const contacts = storage.get('contacts');
      const contact = contacts.find(c => c.id === contactId);
      if (contact) {
        contact.status = newStatus;
        storage.set('contacts', contacts);
        loadPageData('contacts');
      }
    }

    function autoUpdateContactStatus(contactEmail, eventType) {
      const autoStatus = document.getElementById('autoStatusToggle')?.checked ?? true;
      if (!autoStatus) return;

      const contacts = storage.get('contacts');
      const contact = contacts.find(c => c.email === contactEmail);
      
      if (!contact) return;

      switch(eventType) {
        case 'email_sent':
          contact.emailsSent = (contact.emailsSent || 0) + 1;
          if (contact.status === 'prospect') {
            contact.status = 'reached_out';
          } else if (contact.emailsSent >= 2 && contact.emailsReceived > 0) {
            contact.status = 'follow_up';
          } else if (contact.emailsSent >= 3 && contact.emailsReceived === 0) {
            contact.status = 'unresponsive';
          }
          break;
          
        case 'email_received':
          contact.emailsReceived = (contact.emailsReceived || 0) + 1;
          if (contact.emailsReceived === 1) {
            contact.status = 'responded';
          } else if (contact.emailsReceived >= 2) {
            contact.status = 'engaged';
          }
          break;
      }

      storage.set('contacts', contacts);
    }

    function logEmailActivity(contactEmail, type, subject) {
      const activity = storage.get('emailActivity') || [];
      activity.push({
        contactEmail,
        type,
        subject,
        timestamp: new Date().toISOString()
      });
      storage.set('emailActivity', activity);
      
      autoUpdateContactStatus(contactEmail, type);
    }

    // Template Functions
    function saveTemplate() {
      const name = document.getElementById('templateName').value;
      const subject = document.getElementById('templateSubject').value;
      const body = document.getElementById('templateBody').value;

      const templates = storage.get('templates');
      templates.push({
        id: Date.now(),
        name,
        subject,
        body,
        createdDate: new Date().toISOString()
      });

      storage.set('templates', templates);
      closeModal('templateModal');
      loadPageData('templates');
    }

    function loadTemplateOptions() {
      const templates = storage.get('templates');
      const select = document.getElementById('campaignTemplate');
      select.innerHTML = '<option value="">Choose a template...</option>';
      
      templates.forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = template.name;
        select.appendChild(option);
      });
    }

    function deleteTemplate(id) {
      if (!confirm('Are you sure you want to delete this template?')) return;
      
      const templates = storage.get('templates').filter(t => t.id !== id);
      storage.set('templates', templates);
      loadPageData('templates');
    }

    // Campaign Functions
    let followUpCount = 0;

    function addFollowUpStep() {
      followUpCount++;
      const container = document.getElementById('sequenceSteps');
      const step = document.createElement('div');
      step.className = 'sequence-step';
      step.innerHTML = `
        <div class="step-header">
          <span class="step-number">Step ${followUpCount + 1}: Follow-up</span>
          <button type="button" class="action-btn" onclick="this.closest('.sequence-step').remove()">üóëÔ∏è</button>
        </div>
        <div class="form-group" style="margin-bottom: 0.5rem;">
          <label class="form-label" style="font-size: 0.85rem;">Wait Time (days)</label>
          <input type="number" class="form-input" value="3" min="1" style="padding: 0.5rem;">
        </div>
        <div class="form-group" style="margin-bottom: 0;">
          <label class="form-label" style="font-size: 0.85rem;">Message</label>
          <textarea class="form-textarea" style="min-height: 80px;" placeholder="Follow-up message..."></textarea>
        </div>
      `;
      container.appendChild(step);
    }

    function saveCampaign() {
      const name = document.getElementById('campaignName').value;
      const templateId = parseInt(document.getElementById('campaignTemplate').value);
      const segment = document.getElementById('campaignSegment').value;

      if (!templateId) {
        alert('Please select a template');
        return;
      }

      const campaigns = storage.get('campaigns');
      campaigns.push({
        id: Date.now(),
        name,
        templateId,
        segment,
        status: 'draft',
        createdDate: new Date().toISOString(),
        sent: 0,
        opened: 0,
        clicked: 0,
        replied: 0
      });

      storage.set('campaigns', campaigns);
      closeModal('campaignModal');
      loadPageData('campaigns');
      updateDashboard();
    }

    function launchCampaign(id) {
      if (!confirm('Launch this campaign? This will send emails to the selected segment.')) return;
      
      const campaigns = storage.get('campaigns');
      const campaign = campaigns.find(c => c.id === id);
      if (!campaign) return;

      campaign.status = 'active';
      const contacts = storage.get('contacts');
      const targetContacts = campaign.segment === 'all' 
        ? contacts 
        : contacts.filter(c => c.segment === campaign.segment);
      
      const templates = storage.get('templates');
      const template = templates.find(t => t.id === campaign.templateId);
      
      if (!template) {
        alert('Template not found!');
        return;
      }

      const auth = storage.get('msftAuth');
      const useMicrosoft = auth && Date.now() < auth.expiresAt;

      if (useMicrosoft) {
        // Send real emails via Microsoft with rate limiting
        sendEmailsWithRateLimit(targetContacts, template, campaign, campaigns);
      } else {
        // Simulate email sending and update statuses
        targetContacts.forEach(contact => {
          logEmailActivity(contact.email, 'email_sent', template.subject);
        });
        
        campaign.sent = targetContacts.length;
        storage.set('campaigns', campaigns);
        loadPageData('campaigns');
        updateDashboard();
        // Refresh contacts to show updated statuses
        if (document.getElementById('contacts').classList.contains('active')) {
          loadPageData('contacts');
        }
        alert(`Campaign launched! ${targetContacts.length} emails queued.\n\nContact statuses have been updated to "Reached Out".\n\nConnect Microsoft 365 in Settings to send real emails.`);
      }
    }

    async function sendEmailsWithRateLimit(targetContacts, template, campaign, campaigns) {
      // Show progress modal
      const progressModal = document.createElement('div');
      progressModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
      progressModal.innerHTML = `
        <div style="background: var(--bg-secondary); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-color); min-width: 400px;">
          <h3 style="color: var(--text-primary); margin-bottom: 1rem;">Sending Emails...</h3>
          <div style="color: var(--text-secondary); margin-bottom: 1rem;">
            <span id="progressText">Sending 0 of ${targetContacts.length}</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
          <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 1rem;">Please keep this window open...</p>
        </div>
      `;
      document.body.appendChild(progressModal);

      let sentCount = 0;
      let failedCount = 0;
      
      // Send emails with 500ms delay between each (max ~120 emails per minute)
      for (let i = 0; i < targetContacts.length; i++) {
        const contact = targetContacts[i];
        
        try {
          const personalizedSubject = personalizeText(template.subject, contact);
          const personalizedBody = personalizeText(template.body, contact);
          
          await sendEmailViaMicrosoft(contact.email, personalizedSubject, personalizedBody);
          logEmailActivity(contact.email, 'email_sent', personalizedSubject);
          sentCount++;
          
          // Update progress
          document.getElementById('progressText').textContent = `Sent ${sentCount} of ${targetContacts.length}`;
          document.getElementById('progressFill').style.width = `${(sentCount / targetContacts.length) * 100}%`;
          
          // Wait 500ms before next email (rate limiting)
          if (i < targetContacts.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        } catch (error) {
          console.error('Error sending to ' + contact.email, error);
          failedCount++;
          
          // If we hit rate limit, wait longer
          if (error.message.includes('429') || error.message.includes('throttle')) {
            console.log('Rate limit hit, waiting 5 seconds...');
            await new Promise(resolve => setTimeout(resolve, 5000));
          }
        }
      }
      
      // Remove progress modal
      document.body.removeChild(progressModal);
      
      // Update campaign
      campaign.sent = sentCount;
      storage.set('campaigns', campaigns);
      loadPageData('campaigns');
      updateDashboard();
      
      // Refresh contacts to show updated statuses
      if (document.getElementById('contacts').classList.contains('active')) {
        loadPageData('contacts');
      }
      
      // Show results
      if (failedCount > 0) {
        alert(`Campaign complete!\n\n‚úÖ Successfully sent: ${sentCount}\n‚ùå Failed: ${failedCount}\n\nContact statuses have been updated to "Reached Out".`);
      } else {
        alert(`Campaign launched! ${sentCount} emails sent via Microsoft 365.\n\nContact statuses have been updated to "Reached Out".`);
      }
    }

    function personalizeText(text, contact) {
      return text
        .replace(/\{\{name\}\}/g, contact.name)
        .replace(/\{\{email\}\}/g, contact.email)
        .replace(/\{\{company\}\}/g, contact.company || '')
        .replace(/\{\{title\}\}/g, contact.title || '')
        .replace(/\{\{location\}\}/g, contact.location || '');
    }

    function deleteCampaign(id) {
      if (!confirm('Are you sure you want to delete this campaign?')) return;
      
      const campaigns = storage.get('campaigns').filter(c => c.id !== id);
      storage.set('campaigns', campaigns);
      loadPageData('campaigns');
      updateDashboard();
    }

    function exportData() {
      const data = {
        contacts: storage.get('contacts'),
        templates: storage.get('templates'),
        campaigns: storage.get('campaigns'),
        emailActivity: storage.get('emailActivity')
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'sama-outreach-data.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    function clearAllData() {
      if (!confirm('Are you sure? This will delete ALL contacts, templates, campaigns, and settings. This cannot be undone!')) return;
      if (!confirm('Really? This is your last chance!')) return;
      
      localStorage.clear();
      storage.init();
      alert('All data has been cleared.');
      location.reload();
    }

    function updateSettingsPage() {
      const auth = storage.get('msftAuth');
      const statusEl = document.getElementById('msftStatus');
      const btnEl = document.getElementById('msftConnectBtn');
      
      if (auth && Date.now() < auth.expiresAt) {
        statusEl.innerHTML = '<span class="badge badge-success">‚úì Connected</span>';
        btnEl.textContent = 'Reconnect';
        btnEl.classList.remove('btn-primary');
        btnEl.classList.add('btn-secondary');
      } else {
        statusEl.innerHTML = '<span class="badge badge-warning">Not Connected</span>';
        btnEl.textContent = 'Connect Account';
        btnEl.classList.remove('btn-secondary');
        btnEl.classList.add('btn-primary');
      }
    }

    // Load Page Data
    function loadPageData(page) {
      switch(page) {
        case 'dashboard':
          updateDashboard();
          break;
        case 'contacts':
          renderContacts();
          break;
        case 'templates':
          renderTemplates();
          break;
        case 'campaigns':
          renderCampaigns();
          break;
        case 'analytics':
          renderAnalytics();
          break;
        case 'settings':
          updateSettingsPage();
          break;
      }
    }

    function updateDashboard() {
      const contacts = storage.get('contacts');
      const campaigns = storage.get('campaigns');
      const activeCampaigns = campaigns.filter(c => c.status === 'active');
      
      const totalSent = campaigns.reduce((sum, c) => sum + (c.sent || 0), 0);
      const totalReplied = campaigns.reduce((sum, c) => sum + (c.replied || 0), 0);
      
      // Count actual replies from email activity
      const activity = storage.get('emailActivity') || [];
      const actualReplies = activity.filter(a => a.type === 'email_received').length;
      
      const responseRate = totalSent > 0 ? ((actualReplies / totalSent) * 100).toFixed(1) : 0;

      document.getElementById('totalContacts').textContent = contacts.length;
      document.getElementById('activeCampaigns').textContent = activeCampaigns.length;
      document.getElementById('emailsSent').textContent = totalSent;
      document.getElementById('responseRate').textContent = responseRate + '%';

      // Recent campaigns
      const recentCampaigns = campaigns.slice(-5).reverse();
      const tableHtml = recentCampaigns.length > 0 ? `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Campaign</th>
                <th>Status</th>
                <th>Sent</th>
                <th>Opened</th>
                <th>Replied</th>
              </tr>
            </thead>
            <tbody>
              ${recentCampaigns.map(c => `
                <tr>
                  <td>${c.name}</td>
                  <td><span class="badge badge-${c.status === 'active' ? 'success' : c.status === 'draft' ? 'warning' : 'info'}">${c.status}</span></td>
                  <td>${c.sent || 0}</td>
                  <td>${c.opened || 0}</td>
                  <td>${c.replied || 0}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      ` : '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-title">No campaigns yet</div><p>Create your first campaign to get started</p></div>';
      
      document.getElementById('recentCampaignsTable').innerHTML = tableHtml;

      // Recent replies
      const recentReplies = activity
        .filter(a => a.type === 'email_received')
        .slice(-10)
        .reverse();
      
      const repliesHtml = recentReplies.length > 0 ? `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Contact</th>
                <th>Subject</th>
                <th>Received</th>
              </tr>
            </thead>
            <tbody>
              ${recentReplies.map(r => {
                const contact = contacts.find(c => c.email === r.contactEmail);
                const timeAgo = getTimeAgo(new Date(r.timestamp));
                return `
                  <tr>
                    <td>${contact ? contact.name : r.contactEmail}</td>
                    <td>${r.subject || 'No subject'}</td>
                    <td>${timeAgo}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      ` : '<div class="empty-state"><div class="empty-state-icon">üì¨</div><div class="empty-state-title">No replies yet</div><p>Click "Sync Inbox" to check for replies</p></div>';
      
      document.getElementById('recentRepliesContainer').innerHTML = repliesHtml;
      
      updateLastSyncTime();
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      return `${diffDays}d ago`;
    }

    function renderContacts() {
      const contacts = storage.get('contacts');
      renderContactsTable(contacts);
    }

    function renderContactsTable(contacts) {
      const container = document.getElementById('contactsTableContainer');
      
      if (contacts.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üë•</div><div class="empty-state-title">No contacts found</div><p>Add your first contact or adjust your filters</p></div>';
        return;
      }

      const getStatusBadge = (status) => {
        const badges = {
          'prospect': 'info',
          'reached_out': 'warning',
          'responded': 'success',
          'follow_up': 'info',
          'engaged': 'success',
          'unresponsive': 'danger'
        };
        const label = status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        return `<span class="badge badge-${badges[status] || 'info'}">${label}</span>`;
      };

      container.innerHTML = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Company</th>
                <th>Title</th>
                <th>Location</th>
                <th>Segment</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${contacts.map(c => `
                <tr>
                  <td>${c.name}</td>
                  <td>${c.email}</td>
                  <td>${c.company || '-'}</td>
                  <td>${c.title || '-'}</td>
                  <td>${c.location || '-'}</td>
                  <td><span class="badge badge-info">${c.segment}</span></td>
                  <td>
                    <select class="form-select" style="padding: 0.35rem 0.5rem; font-size: 0.8rem; width: auto; display: inline-block;" onchange="updateContactStatus(${c.id}, this.value)">
                      <option value="prospect" ${c.status === 'prospect' ? 'selected' : ''}>Prospect</option>
                      <option value="reached_out" ${c.status === 'reached_out' ? 'selected' : ''}>Reached Out</option>
                      <option value="responded" ${c.status === 'responded' ? 'selected' : ''}>Responded</option>
                      <option value="follow_up" ${c.status === 'follow_up' ? 'selected' : ''}>Follow-up</option>
                      <option value="engaged" ${c.status === 'engaged' ? 'selected' : ''}>Engaged</option>
                      <option value="unresponsive" ${c.status === 'unresponsive' ? 'selected' : ''}>Unresponsive</option>
                    </select>
                  </td>
                  <td>
                    <button class="action-btn" onclick="deleteContact(${c.id})" title="Delete">üóëÔ∏è</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function renderTemplates() {
      const templates = storage.get('templates');
      const container = document.getElementById('templatesContainer');
      
      if (templates.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><div class="empty-state-title">No templates yet</div><p>Create your first email template</p></div>';
        return;
      }

      container.innerHTML = templates.map(t => `
        <div class="card" style="margin-bottom: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">${t.name}</h4>
              <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">
                <strong>Subject:</strong> ${t.subject}
              </div>
              <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; white-space: pre-wrap; color: var(--text-secondary);">${t.body.substring(0, 200)}${t.body.length > 200 ? '...' : ''}</div>
            </div>
            <button class="action-btn" onclick="deleteTemplate(${t.id})" title="Delete">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    function renderCampaigns() {
      const campaigns = storage.get('campaigns');
      const templates = storage.get('templates');
      const container = document.getElementById('campaignsContainer');
      
      if (campaigns.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üöÄ</div><div class="empty-state-title">No campaigns yet</div><p>Create your first automated campaign</p></div>';
        return;
      }

      container.innerHTML = campaigns.map(c => {
        const template = templates.find(t => t.id === c.templateId);
        return `
          <div class="card" style="margin-bottom: 1rem;">
            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
              <div style="flex: 1;">
                <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">${c.name}</h4>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                  Template: ${template ? template.name : 'Unknown'} | Target: ${c.segment}
                </div>
              </div>
              <div style="display: flex; gap: 0.5rem; align-items: center;">
                <span class="badge badge-${c.status === 'active' ? 'success' : c.status === 'draft' ? 'warning' : 'info'}">${c.status}</span>
                ${c.status === 'draft' ? `<button class="btn btn-primary btn-sm" onclick="launchCampaign(${c.id})">üöÄ Launch</button>` : ''}
                <button class="action-btn" onclick="deleteCampaign(${c.id})" title="Delete">üóëÔ∏è</button>
              </div>
            </div>
            <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
              <div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);">${c.sent || 0}</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Sent</div>
              </div>
              <div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);">${c.opened || 0}</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Opened</div>
              </div>
              <div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);">${c.clicked || 0}</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Clicked</div>
              </div>
              <div>
                <div style="font-size: 1.5rem; font-weight: 700; color: var(--accent-primary);">${c.replied || 0}</div>
                <div style="font-size: 0.8rem; color: var(--text-secondary);">Replied</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderAnalytics() {
      const campaigns = storage.get('campaigns');
      const activeCampaigns = campaigns.filter(c => c.status === 'active');
      
      const totalSent = campaigns.reduce((sum, c) => sum + (c.sent || 0), 0);
      const totalOpened = campaigns.reduce((sum, c) => sum + (c.opened || 0), 0);
      const totalClicked = campaigns.reduce((sum, c) => sum + (c.clicked || 0), 0);
      const totalReplied = campaigns.reduce((sum, c) => sum + (c.replied || 0), 0);

      const openRate = totalSent > 0 ? ((totalOpened / totalSent) * 100).toFixed(1) : 0;
      const clickRate = totalSent > 0 ? ((totalClicked / totalSent) * 100).toFixed(1) : 0;
      const replyRate = totalSent > 0 ? ((totalReplied / totalSent) * 100).toFixed(1) : 0;
      const bounceRate = 0;

      document.getElementById('openRate').textContent = openRate + '%';
      document.getElementById('clickRate').textContent = clickRate + '%';
      document.getElementById('replyRate').textContent = replyRate + '%';
      document.getElementById('bounceRate').textContent = bounceRate + '%';

      const container = document.getElementById('analyticsTable');
      
      if (activeCampaigns.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìä</div><div class="empty-state-title">No active campaigns</div><p>Launch a campaign to see analytics</p></div>';
        return;
      }

      container.innerHTML = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Campaign</th>
                <th>Sent</th>
                <th>Open Rate</th>
                <th>Click Rate</th>
                <th>Reply Rate</th>
              </tr>
            </thead>
            <tbody>
              ${activeCampaigns.map(c => {
                const cOpenRate = c.sent > 0 ? ((c.opened / c.sent) * 100).toFixed(1) : 0;
                const cClickRate = c.sent > 0 ? ((c.clicked / c.sent) * 100).toFixed(1) : 0;
                const cReplyRate = c.sent > 0 ? ((c.replied / c.sent) * 100).toFixed(1) : 0;
                return `
                  <tr>
                    <td>${c.name}</td>
                    <td>${c.sent || 0}</td>
                    <td>${cOpenRate}%</td>
                    <td>${cClickRate}%</td>
                    <td>${cReplyRate}%</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Initialize
    storage.init();
    
    // Load stored client ID if exists
    const storedClientId = storage.get('msftClientId');
    if (storedClientId) {
      msftConfig.clientId = storedClientId;
    }
    
    handleMicrosoftCallback();
    updateDashboard();
  </script>
</body>
</html>
